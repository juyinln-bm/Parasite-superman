<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŸ²èŸ²å±æ©Ÿ</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding-bottom: 50px; }
        h2 { color: #333; margin: 20px 0; }
        
        /* å€å¡Šæ§åˆ¶ */
        .section { display: none; width: 100%; max-width: 600px; flex-direction: column; align-items: center; }
        .active { display: flex; }

        /* ç™»å…¥å€å¡Š */
        .login-box { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; width: 90%; }
        .login-box input, .login-box select { padding: 12px; font-size: 18px; width: 80%; border: 2px solid #ddd; border-radius: 5px; margin-bottom: 20px; }
        
        /* ========== éŠæˆ²å€åŸŸé…ç½® (ç¸®å°ç‰ˆ) ========== */
        .game-area { 
            width: 95%;          
            max-width: 500px;    /* å¾ 550px ç¸®å°è‡³ 500px */
            height: 680px;       /* å¾ 750px ç¸®å°è‡³ 680px */
            margin-bottom: 10px; 
            position: relative;
            display: flex;
            flex-direction: column; 
            gap: 10px; 
        }

        /* 1. éœæ…‹åœ–ç‰‡å€ (ç­‰æ¯”ç¸®å°) */
        .static-img-container {
            width: 100%;
            height: 400px;       /* å¾ 450px ç¸®å°è‡³ 400px */
            background: white;
            border-radius: 15px;
            padding: 5px;        
            box-sizing: border-box;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ddd;
            cursor: pointer;
            overflow: hidden;    
        }

        .parasite-img { 
            width: 100%;         
            height: 100%;        
            object-fit: contain; 
        }

        /* 2. éœæ…‹æç¤ºå€ */
        .static-hint-area {
            height: 25px; /* ç¨å¾®ç¸®å° */
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        /* 3. ä¸‹æ–¹çš„ç¿»è½‰å¡ç‰‡ */
        .card-container {
            perspective: 600px;
            width: 100%;
            flex: 1; 
            min-height: 180px; /* å¾ 200px ç¸®å°è‡³ 180px */
            position: relative;
        }

        .card { 
            width: 100%; 
            height: 100%; 
            position: relative; 
            transition: transform 0.6s; 
            transform-style: preserve-3d; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
            border-radius: 15px; 
        }
        
        .card.is-flipped { transform: rotateY(180deg); }
        
        .card__face { 
            position: absolute; 
            width: 100%; 
            height: 100%; 
            backface-visibility: hidden; 
            border-radius: 15px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            background: white; 
            padding: 12px; /* å¾ 15px ç¸®å°è‡³ 12px */
            box-sizing: border-box; 
        }
        
        .card__face--front { background: #ffffff; }
        .card__face--back { background: #f8f9fa; transform: rotateY(180deg); text-align: center; }
        
        /* è¼¸å…¥èˆ‡æŒ‰éˆ• (é…åˆç¸®å°èª¿æ•´å­—é«”èˆ‡é–“è·) */
        input[type="text"] { 
            padding: 10px;        /* ç¸®å° padding */
            width: 90%; 
            margin-bottom: 10px;  /* ç¸®å° margin */
            border: 2px solid #ddd; 
            border-radius: 5px; 
            font-size: 16px;      /* å¾ 18px ç¸®å°è‡³ 16px */
        }
        button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background 0.3s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        /* é¦–é æŒ‰éˆ•ç¾¤ */
        .btn-group { display: flex; flex-direction: column; gap: 10px; width: 100%; align-items: center; }
        .btn-start { font-size: 18px; padding: 12px 30px; background-color: #28a745; width: 80%; }
        .btn-start:hover { background-color: #218838; }
        .btn-practice { font-size: 18px; padding: 12px 30px; background-color: #6c757d; width: 80%; }
        .btn-practice:hover { background-color: #5a6268; }
        .btn-flashcard { font-size: 18px; padding: 12px 30px; background-color: #fd7e14; width: 80%; }
        .btn-flashcard:hover { background-color: #e36d0d; }
        .btn-gallery { font-size: 18px; padding: 12px 30px; background-color: #17a2b8; width: 80%; }
        .btn-gallery:hover { background-color: #138496; }

        .btn-restart { background-color: #17a2b8; margin-top: 10px; }

        /* çµæœé¡¯ç¤º */
        .result-text { font-size: 22px; font-weight: bold; margin-bottom: 5px; } /* å­—é«”å¾®èª¿ */
        .correct { color: #28a745; } .wrong { color: #dc3545; }
        .answer-detail { font-size: 16px; color: #555; margin-bottom: 8px; width: 100%; } /* å­—é«”å¾®èª¿ */
        
        /* æè¿°å€å¡Šæ¨£å¼ */
        .desc-box {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 8px;
            border-radius: 5px;
            font-size: 14px; /* å¾ 15px ç¸®å°è‡³ 14px */
            margin-bottom: 8px;
            text-align: left;
            width: 100%;
            flex: 1; 
            overflow-y: auto;
        }

        /* è¨ˆæ™‚å™¨æ¨£å¼ (å¯¬åº¦é™åˆ¶è·Ÿéš¨ game-area) */
        .timer-container { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; width: 95%; max-width: 500px; }
        .timer-bar-bg { width: 100%; height: 8px; background: #e9ecef; border-radius: 5px; overflow: hidden; }
        .timer-bar-fill { height: 100%; background: #28a745; width: 100%; transition: width 1s linear, background 0.3s; }
        .timer-warning { background: #dc3545 !important; }

        .progress { margin-top: 5px; font-size: 14px; color: #666; margin-bottom: 10px;}

        /* ç¿»å¡æ¨¡å¼å°ˆç”¨æç¤º (éœæ…‹) */
        .click-hint { 
            color: #fd7e14; 
            font-weight: bold; 
            font-size: 18px; 
            animation: pulse 1.5s infinite; 
            cursor: pointer; 
            margin: 0;
        }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        /* æ¸¬é©—æç¤ºæ–‡å­— */
        #quiz-hint {
            color: #666;
            font-size: 15px;
            margin: 0;
        }

        /* æˆç¸¾å–®èˆ‡æ’è¡Œæ¦œ */
        #summary-section { width: 95%; max-width: 800px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .tab-buttons { display: flex; justify-content: center; margin-bottom: 20px; border-bottom: 2px solid #eee; }
        .tab-btn { background: none; color: #666; border-radius: 0; padding: 10px 20px; margin: 0 10px; border-bottom: 3px solid transparent; }
        .tab-btn.active-tab { color: #007bff; border-bottom: 3px solid #007bff; }
        
        .list-container { display: none; }
        .list-container.show { display: block; }

        /* å€‹äººæˆç¸¾åˆ—è¡¨ & åœ–é‘‘åˆ—è¡¨ */
        .summary-item { display: flex; align-items: center; border-bottom: 1px solid #f0f0f0; padding: 10px 0; }
        .summary-item.item-wrong { background-color: #fff0f0; border-left: 5px solid #dc3545; padding-left: 10px; }
        .summary-thumb { width: 80px; height: 80px; object-fit: cover; border-radius: 5px; margin-right: 15px; cursor: pointer; border: 1px solid #eee; }
        .summary-info { flex: 1; text-align: left; }
        .status-badge { font-weight: bold; padding: 3px 8px; border-radius: 5px; font-size: 12px; }
        .status-badge.ok { background-color: #d4edda; color: #155724; }
        .status-badge.no { background-color: #f8d7da; color: #721c24; }

        /* åœ–é‘‘æ¨¡å¼è¡¨æ ¼æ¨£å¼ */
        #gallery-section { width: 98%; max-width: 900px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .gallery-filter { margin-bottom: 20px; text-align: center; }
        .gallery-filter select { padding: 10px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; }
        
        .gallery-table { width: 100%; border-collapse: collapse; font-size: 15px; }
        .gallery-table th, .gallery-table td { border: 1px solid #eee; padding: 10px; text-align: left; vertical-align: middle; }
        .gallery-table th { background-color: #f8f9fa; color: #333; font-weight: bold; position: sticky; top: 0; }
        .gallery-table tr:hover { background-color: #f1f1f1; }
        
        .gallery-thumb-small { width: 60px; height: 60px; object-fit: cover; border-radius: 5px; cursor: pointer; border: 1px solid #ddd; }
        
        .gallery-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .gallery-overlay img { max-width: 95%; max-height: 80%; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .gallery-overlay-text { color: white; margin-top: 20px; font-size: 20px; font-weight: bold; text-align: center; background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 50px; }
        .gallery-desc-text { color: #f0f0f0; margin-top: 10px; font-size: 16px; background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 10px;}
        .gallery-close { position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; cursor: pointer; }

        /* æ’è¡Œæ¦œè¡¨æ ¼ */
        #leaderboard-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        #leaderboard-table th, #leaderboard-table td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; }
        #leaderboard-table th { background-color: #f8f9fa; color: #333; }
        .rank-1 { color: #d4af37; font-weight: bold; font-size: 1.2em; }
        .rank-2 { color: #c0c0c0; font-weight: bold; }
        .rank-3 { color: #cd7f32; font-weight: bold; }

        /* æ§åˆ¶å€ */
        .controls {
            margin-top: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            max-width: 500px; /* è·Ÿéš¨ game-area */
            gap: 15px;
        }

        .nav-btn {
            background-color: #6c757d;
            padding: 8px 15px;
            font-size: 0.9em;
            width: auto;
        }

        #submit-early-btn {
            background-color: #dc2626;
            color: white;
            text-align: center;
            border: none;
            padding: 8px 20px;
            font-size: 1em;
            width: auto;
            max-width: 200px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #submit-early-btn:hover { background-color: #b91c1c; }

        /* ç§’æ•¸é¸æ“‡å½ˆçª—æ¨£å¼ */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 2000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.5); 
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            width: 90%;
            max-width: 300px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .timer-btn {
            display: block;
            width: 100%;
            margin: 10px 0;
            padding: 12px;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: white;
        }

        .btn-40s { background-color: #28a745; }
        .btn-40s:hover { background-color: #218838; }
        
        .btn-50s { background-color: #17a2b8; }
        .btn-50s:hover { background-color: #138496; }

        .btn-cancel { background-color: #6c757d; }
        .btn-cancel:hover { background-color: #5a6268; }

    </style>
</head>
<body>

    <div id="login-section" class="section active">
        <h2>ğŸ¤¡ æ¶æ•‘å¯„ç”ŸèŸ²å¤§ä½œæˆ°</h2>
        <div class="login-box">
            
            <p>é¸æ“‡ç·´ç¿’ç¯„åœ</p>
            <select id="category-select">
                <option value="all">ğŸ”¥ æˆ‘å…¨éƒ½è¦</option>
                <option value="ç·šèŸ²">ğŸª± ç·šèŸ² </option>
                <option value="çµ›èŸ²">ğŸ—ï¸ çµ›èŸ² </option>
                <option value="å¸èŸ²">ğŸƒ å¸èŸ² </option>
                <option value="åŸèŸ²">ğŸ¦  åŸèŸ² </option>
            </select>

            <p>è¨­å®šé¡Œæ•¸ (è·‘å°é è¨­ 10 é¡Œ)</p>
            <input type="number" id="question-limit" value="10" min="1" max="100" placeholder="è¼¸å…¥é¡Œæ•¸">

            <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">

            <p>è¼¸å…¥æš±ç¨±(è¨ˆæ™‚æ‰é ˆç”¨)</p>
            <input type="text" id="nickname" placeholder="...." maxlength="10">
            
            <div class="btn-group">
                <button class="btn-start" onclick="checkStart('ranked')">ğŸ† è¨ˆæ™‚æŒ‘æˆ°</button>
                <button class="btn-practice" onclick="checkStart('practice')">ğŸ“ ç·´ç¿’æ¨¡å¼ </button>
                <button class="btn-flashcard" onclick="checkStart('flashcard')">ğŸƒ ç¿»å¡è¨˜æ†¶ </button>
                <button class="btn-gallery" onclick="openGallery()">ğŸ“– ç€è¦½åœ–é‘‘</button>
            </div>
        </div>
    </div>

    <div id="timer-modal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top:0;">â±ï¸ é¸æ“‡æŒ‘æˆ°ç§’æ•¸</h3>
            <button class="timer-btn btn-40s" onclick="confirmRanked(40)">40 ç§’ (æ¨™æº–)</button>
            <button class="timer-btn btn-50s" onclick="confirmRanked(50)">50 ç§’ (ç»ç‰‡è¢«å‹•åˆ°äº†)</button>
            <button class="timer-btn btn-cancel" onclick="closeTimerModal()">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="game-section" class="section">
        <h3 id="player-display">Player: </h3>
        
        <div id="timer-area" class="timer-container" style="display: none;">
            <span>â±ï¸ <span id="timer-text">40</span>s</span>
            <div class="timer-bar-bg">
                <div id="timer-bar" class="timer-bar-fill"></div>
            </div>
        </div>

        <div class="game-area">
            <div class="static-img-container" onclick="onCardClick()">
                <img src="" alt="é¡Œç›®åœ–ç‰‡" class="parasite-img" id="q-image">
            </div>

            <div class="static-hint-area">
                <div id="flashcard-hint" class="click-hint" style="display:none;">ğŸ‘† é»æ“Šçœ‹ç­”æ¡ˆ</div>
                <div id="quiz-hint" style="display:none;">è«‹è¼¸å…¥æ­£ç¢ºåç¨±ï¼š</div>
            </div>

            <div class="card-container">
                <div class="card" id="flashcard" onclick="onCardClick()">
                    <div class="card__face card__face--front">
                        <div id="input-area" style="width:100%;">
                            <input type="text" id="user-input" placeholder="è€ƒè©¦å­¸åè¨˜å¾—å¤§å¯« é€™è£¡ä¸ç”¨" autocomplete="off">
                            <button onclick="checkAnswer(event)" style="width:100%;">é€å‡º</button>
                        </div>
                    </div>
                    
                    <div class="card__face card__face--back">
                        <div id="result-title" class="result-text"></div>
                        
                        <div class="answer-detail">
                            æ­£ç¢ºç­”æ¡ˆï¼š<br>
                            <strong id="correct-answer" style="color: #333; font-size: 20px;"></strong>
                        </div>
                        
                        <div id="ans-desc" class="desc-box">
                            </div>

                        <button onclick="nextQuestion(event)" id="card-next-btn">ä¸‹ä¸€é¡Œ â¡ï¸</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="progress" id="progress-text">æº–å‚™é–‹å§‹...</div>

        <div class="controls">
            <button id="prev-btn" class="nav-btn" onclick="prevQuestion()">â¬…ï¸ ä¸Šä¸€é¡Œ</button>
            <button id="submit-early-btn" onclick="endGame()">ğŸšª ææ—©äº¤å·</button>
            <button id="skip-btn" class="nav-btn" onclick="nextQuestion(event)">ä¸‹ä¸€é¡Œ â¡ï¸</button>
        </div>
    </div>

    <div id="summary-section" class="section">
        <div id="score-tabs" class="tab-buttons">
            <button class="tab-btn active-tab" onclick="switchTab('personal')">ğŸ“„ å€‹äººæˆç¸¾å–®</button>
            <button class="tab-btn" id="btn-leaderboard" onclick="switchTab('leaderboard')">ğŸ† ç·šä¸Šæ’è¡Œæ¦œ</button>
        </div>

        <div style="text-align: center; margin-bottom: 20px;">
            <h3 id="final-score"></h3>
            <div id="upload-status" style="font-size: 14px; color: #666;"></div>
        </div>

        <div id="personal-list" class="list-container show"></div>

        <div id="leaderboard-list" class="list-container">
            <table id="leaderboard-table">
                <thead><tr><th>æ’å</th><th>æš±ç¨±</th><th>å¾—åˆ†</th></tr></thead>
                <tbody id="rank-body"><tr><td colspan="3">è¼‰å…¥ä¸­...</td></tr></tbody>
            </table>
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button class="btn-restart" onclick="location.reload()">å›åˆ°é¦–é  ğŸ </button>
        </div>
    </div>

    <div id="gallery-section" class="section">
        <h3 style="text-align:center;">ğŸ“– å¯„ç”ŸèŸ²åœ–é‘‘å¤§å…¨</h3>
        
        <div style="text-align: center; margin-bottom: 15px;">
            <button class="btn-restart" onclick="location.reload()">å›åˆ°é¦–é  ğŸ </button>
        </div>

        <p style="text-align:center; color:#666; font-size:0.9em;">é»æ“Šåœ–ç‰‡å¯æ”¾å¤§æª¢è¦–</p>
        
        <div class="gallery-filter">
            <select id="gallery-filter-select" onchange="filterGallery()">
                <option value="all">å…¨éƒ¨é¡¯ç¤º</option>
                <option value="ç·šèŸ²">ç·šèŸ²</option>
                <option value="çµ›èŸ²">çµ›èŸ²</option>
                <option value="å¸èŸ²">å¸èŸ²</option>
                <option value="åŸèŸ²">åŸèŸ²</option>
            </select>
        </div>
        
        <div id="gallery-container"></div>
    </div>

    <div id="gallery-overlay" class="gallery-overlay" onclick="closeGalleryOverlay()">
        <span class="gallery-close">&times;</span>
        <img id="overlay-img" src="">
        <div id="overlay-text" class="gallery-overlay-text"></div>
        <div id="overlay-desc" class="gallery-desc-text"></div>
        <div style="color:white; margin-top:10px;">(é»æ“Šä»»æ„è™•é—œé–‰)</div>
    </div>

    <script>
        // ==========================================
        // ğŸ”§ è¨­å®šå€ ğŸ”§
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyxzdY2x1ZqsqhE-j_xgNUN0y297YaP4IbMyCb35zsJ7FAE61RGczbbSOC1u5GUi3ykmw/exec";
        
        // è®Šæ•¸åŒ–æ™‚é–“è¨­å®š
        let timePerQuestion = 40; 
        
        // 3. é¡Œç›®è³‡æ–™åº« (å·²åŠ å…¥ desc æ¬„ä½)
        const database = [
            { id: 1, type: 'ç·šèŸ²', img: "images/1.jpg", ans: ["Bursa copulatory of Angiostrongylus cantonensis", "male of Angiostrongylus cantonensis", "Spicule of Angiostrongylus cantonensis"], desc: "å»£æ±ä½è¡€ç·šèŸ² L5é›„èŸ²" },
            { id: 2, type: 'ç·šèŸ²', img: "images/2.jpg", ans: ["Female of Angiostrongylus cantonensis", "Posterior portion of Angiostrongylus cantonensis"], desc: "å»£æ±ä½è¡€ç·šèŸ² L5é›ŒèŸ² å°¾éƒ¨æ•´é«”å‘ˆæºœæ»‘æ¢¯ç‹€" },
            { id: 3, type: 'ç·šèŸ²', img: "images/3.jpg", ans: ["anterior end of Anisakis spp.", "boring tooth of Anisakis spp."], desc: "æµ·ç¸èƒƒç·šèŸ² å‰ç«¯æœ‰boring toothé‘½æ´é½’ï¼Œèˆ‡é ­ç«¯å‘ˆåˆ‡ç·šæ–¹å‘" },
            { id: 4, type: 'ç·šèŸ²', img: "images/4.jpg", ans: ["terminal spine of Anisakis spp."], desc: "æµ·ç¸èƒƒç·šèŸ² å°¾åˆºèˆ‡å°¾ç«¯å‚ç›´" },
            { id: 5, type: 'ç·šèŸ²', img: "images/5.jpg", ans: ["Egg of Trichuris trichiura"], desc: "é­èŸ²åµ Barrel-shaped é…’æ¡¶ç‹€ã€åšåµæ®¼(è½‰å‹•æ™‚æœƒåƒå…©æ¢ç·šçš„è†œ)ã€ç„¡æ©«ç´‹" },
            { id: 6, type: 'ç·šèŸ²', img: "images/6.jpg", ans: ["Cyst of Trichinella Spiralis"], desc: "æ—‹æ¯›èŸ²" },
            { id: 7, type: 'ç·šèŸ²', img: "images/7.jpg", ans: ["adult male of Trichuris trichiura"], desc: "é›„é­èŸ² é ­ç´° å°¾ç«¯æœ‰å°–å°–çš„äº¤å°¾åˆº" },
            { id: 8, type: 'ç·šèŸ²', img: "images/8.jpg", ans: ["adult female of Trichuris trichiura"], desc: "é›Œé­èŸ²æˆèŸ² é ­ç´° å°¾åœ“éˆ" },
            { id: 9, type: 'ç·šèŸ²', img: "images/9.jpg", ans: ["Egg of Enterobius vermicularis"], desc: "èŸ¯èŸ²åµ é›™å±¤æ®¼ä¸”ä¸å°ç¨± =  ä¸€é‚Šæ‰ä¸€é‚Šå‡¸" },
            { id: 10, type: 'ç·šèŸ²', img: "images/10.jpg", ans: ["Embryonated egg of Enterobius vermicularis"], desc: "èŸ¯èŸ²èƒèŸ²åµ åµæ®¼ä¸­å‡ºç¾èƒèŸ²(ä¸€æˆ–å¤šæ¢æ‘ºç—•)" },
            { id: 11, type: 'ç·šèŸ²', img: "images/11.jpg", ans: ["female of Enterobius vermicularis", "female adult of Enterobius vermicularis", "adult female of enterobius vermicularis"], desc: "èŸ¯èŸ²çš„é›ŒæˆèŸ² é ­ç«¯å…©å´æœ‰è§’è³ªåŒ–é¼“èµ·çš„å´ç¿¼ é¡¯å¾®é¡ä¸‹å‘ˆç´…è‰²" },
            { id: 12, type: 'ç·šèŸ²', img: "images/12.jpg", ans: ["fertilized egg of Ascaris lumbricoides"], desc: "å—ç²¾è›”èŸ²åµ å¤–å‹åœ“ï¼Œåµç´°èƒé¡†ç²’ç´°å°ä¸”æ’åˆ—ç·Šå¯†ï¼Œæ³¢æµªç‹€å¤–è†œåˆ†å¸ƒå‡å‹»" },
            { id: 13, type: 'ç·šèŸ²', img: "images/13.jpg", ans: ["unfertilized egg of Ascaris lumbricoides"], desc: "æœªå—ç²¾è›”èŸ²åµ å¤–å‹æ©¢åœ“ï¼Œåµç´°èƒé¡†ç²’è¼ƒç²—å¤§ä¸”æ’åˆ—è¼ƒé¬†æ•£ï¼Œæ³¢æµªç‹€å¤–è†œè¼ƒä¸å¹³" },
            { id: 14, type: 'ç·šèŸ²', img: "images/14.jpg", ans: ["embryonated egg of Ascaris lumbricoides"], desc: "è›”èŸ²èƒèŸ²åµ èŸ²é«”èœ·æ›²åœ¨èŸ²åµå…§ï¼Œå†åŠ ä¸Šæ³¢æµªç‹€å¤–è†œç¢ºå®šæ˜¯è›”èŸ²" },
            { id: 15, type: 'ç·šèŸ²', img: "images/15.jpg", ans: ["embryonated egg of hookworm"], desc: "è›”èŸ²èƒèŸ²åµ  ä¼¼èŸ¯èŸ²ï¼Œä½†èŸ¯èŸ²åµæ®¼è¼ƒåšä¸”ä¸€é‚Šè¼ƒå‡¸ä¸€é‚Šè¼ƒæ‰å¹³" },
            { id: 16, type: 'ç·šèŸ²', img: "images/16.jpg", ans: ["egg of hookworm"], desc: "è›”èŸ²èŸ²åµ  ä¼¼èŸ¯èŸ²ï¼Œä½†èŸ¯èŸ²åµæ®¼è¼ƒåšä¸”ä¸€é‚Šè¼ƒå‡¸ä¸€é‚Šè¼ƒæ‰å¹³" },
            { id: 17, type: 'ç·šèŸ²', img: "images/17.jpg", ans: ["Buccal capsule of Ancylostoma duodenale"], desc: "çœ‹åˆ°å°–ç‰™å°±å¯ä»¥ç¢ºå®šæ˜¯åäºŒæŒ‡è…¸é‰¤èŸ²" },
            { id: 18, type: 'ç·šèŸ²', img: "images/18.jpg", ans: ["Buccal capsule of Necator americanus"], desc: "ç„¡ç‰™é½’ã€æœ‰å€’Vå­—å½¢åˆ‡æ¿è€…ç‚ºç¾æ´²é‰¤èŸ²" },
            { id: 19, type: 'ç·šèŸ²', img: "images/19.jpg", ans: ["Filariform larva of Strongyloides stercoralis"], desc: "ç³å°æ¡¿ç·šèŸ²F-form æ²’æœ‰å¤–é˜çµæ§‹ï¼Œä¸”æœ«ç«¯ä¸æœƒå½¢æˆç´°å°–ã€éˆæˆ–æ˜¯å€’V" },
            { id: 20, type: 'ç·šèŸ²', img: "images/20.jpg", ans: ["Filariform Larva of Necator americanus"], desc: "ç¾æ´²é‰¤èŸ²F-form æœ‰å¤–é˜+æœ‰æ˜é¡¯æ©«ç´‹(striation)" },
            { id: 21, type: 'ç·šèŸ²', img: "images/21.jpg", ans: ["Filariform Larva of Ancylostoma duodenale"], desc: "åäºŒæŒ‡è…¸é‰¤èŸ²F-form æœ‰å¤–é˜+ä½†ä¸å…·æœ‰æ©«ç´‹" },
            { id: 22, type: 'ç·šèŸ²', img: "images/22.jpg", ans: ["microfilaria of Wuchereria bancrofti"], desc: "ç­æ°çµ²èŸ²å¾®çµ²èŸ² èŸ²é«”æ²æ›²åº¦ä¸å¤§" },
            { id: 23, type: 'ç·šèŸ²', img: "images/23.jpg", ans: ["microfilaria of Brugia malayi"], desc: "é¦¬ä¾†çµ²èŸ²å¾®çµ²èŸ² éå¸¸æ²æ›²" },
            { id: 24, type: 'å¸èŸ²', img: "images/24.jpg", ans: ["Egg of Fasciolopsis Buski"], desc: "è–‘ç‰‡èŸ²èŸ²åµ é•·æ©¢åœ“å½¢ï¼Œæ·¡é»ƒè‰²æˆ–é»ƒè‰²ï¼Œè–„æ®¼ï¼Œå…§éƒ¨æœ‰ä¸€é¡†ä¸€é¡†çš„åµç´°èƒ" },
            { id: 25, type: 'å¸èŸ²', img: "images/25.jpg", ans: ["Adult worm of Fasciolopsis buski"], desc: "è–‘ç‰‡èŸ²æˆèŸ² è…¸é“æœ€å¤§éš»çš„å¸èŸ²(åªèƒ½çœ‹åˆ°ç´„2/3çš„èŸ²é«”)" },
            { id: 26, type: 'å¸èŸ²', img: "images/26.jpg", ans: ["Adult worm of Metagonimus Yokogawai"], desc: "æ©«å·ç•°å½¢å¸èŸ²æˆèŸ² ä¸­é–“è—è‰²åµå·¢(?) å°¾ç«¯å…©é¡†æ·¡é»ƒè—åœ“çªä¸¸ " },
            { id: 27, type: 'å¸èŸ²', img: "images/27.jpg", ans: ["Adult worm of Echinostoma revolutum"], desc: "å¤–æ—‹æ£˜å£å¸èŸ²æˆèŸ² è…¹å¸ç›¤åœ¨ä¸­é–“é å‰" },
            { id: 28, type: 'å¸èŸ²', img: "images/28.jpg", ans: ["Egg of Paragonimus westermani"], desc: "è¡›æ°è‚ºå¸èŸ²åµ å’Œè–‘ç‰‡èŸ²åµé¡ä¼¼ï¼Œæœ€å¤§çš„ä¸åŒå°±åœ¨æ–¼è¡›æ°è‚ºå¸èŸ²æœ‰æ˜é¡¯åµè“‹ã€ä¸”åµæ¯”è¼ƒå°" },
            { id: 29, type: 'å¸èŸ²', img: "images/29.jpg", ans: ["Adult worm of Paragonimus westermani"], desc: "è¡›æ°è‚ºå¸èŸ²æˆèŸ²" },
            { id: 30, type: 'å¸èŸ²', img: "images/30.jpg", ans: ["Section of liver infected with Paragonimus westermani"], desc: "" },
            { id: 31, type: 'å¸èŸ²', img: "images/31.jpg", ans: ["Adult worm of Fasciola hepatica"], desc: "ç‰›ç¾Šè‚å¸èŸ²æˆèŸ² ä¸€å¨é»‘é»‘çš„å­å®®" },
            { id: 32, type: 'å¸èŸ²', img: "images/32.jpg", ans: ["Adult worm of Clonorchis sinensis"], desc: "ä¸­è¯è‚å¸èŸ²çš„æˆèŸ² ç”Ÿæ®–å™¨å®˜åˆ†éš”æ˜ç¢º" },
            { id: 33, type: 'å¸èŸ²', img: "images/33.jpg", ans: ["Egg of Clonorchis sinensis"], desc: "ä¸­è¯è‚å¸èŸ²èŸ²åµ å°å‹å¸èŸ²åµ é•·æ©¢åœ“å½¢ã€åšæ®¼" },
            { id: 34, type: 'å¸èŸ²', img: "images/34.jpg", ans: ["Egg of Schistosoma haematobium"], desc: "åŸƒåŠè¡€å¸èŸ²åµ ç´¡éŒ˜å½¢å¤–è§€ï¼Œæœ«ç«¯æœ‰terminal spine" },
            { id: 35, type: 'å¸èŸ²', img: "images/35.jpg", ans: ["Egg of Schistosoma mansoni"], desc: "æ›¼æ£®è¡€å¸èŸ²åµ æœ‰lateral spine" },
            { id: 36, type: 'å¸èŸ²', img: "images/36.jpg", ans: ["Egg of Schistosoma japonicum"], desc: "æ—¥æœ¬è¡€å¸èŸ²åµ éç´¡éŒ˜å½¢ï¼Œä¹Ÿæ²’æœ‰spineï¼›è£¡é¢æ˜¯å¹¼èŸ²ï¼Œä¸¦éåµç´°èƒï¼Œæ•…å¯ä»¥ä»¥æ­¤åˆ¤æ–·è¡€å¸èŸ²" },
            { id: 37, type: 'å¸èŸ²', img: "images/37.jpg", ans: ["Adult male of Schistosoma mansoni"], desc: "æ›¼æ£®è¡€å¸èŸ²é›„èŸ²  é ­ç«¯æœ‰å‘å¤–å‡¸å‡ºçš„å¸ç›¤" },
            { id: 38, type: 'å¸èŸ²', img: "images/38.jpg", ans: ["Adult female of Schistosoma mansoni"], desc: "æ›¼æ£®è¡€å¸èŸ²é›ŒèŸ² è¼ƒç´°é•·ã€å¸ç›¤ä¸æ˜é¡¯" },
            { id: 39, type: 'åŸèŸ²', img: "images/39.jpg", ans: ["Cyst of Entamoeba coli", "Cyst form of Entamoeba coli"], desc: "å¤§è…¸é˜¿ç±³å·´çš„å›Šé«” 5é¡†ä»¥ä¸Šçš„æ ¸å°±èƒ½å¤ åˆ¤æ–·ç‚ºå¤§è…¸é˜¿ç±³å·´" },
            { id: 41, type: 'åŸèŸ²', img: "images/41.jpg", ans: ["Cyst of Endolimax nana", "Cyst form of Endolimax nana"], desc: "å¾®å°é˜¿ç±³å·´çš„å›Šé«” ï¼Œå››é¡†ç´°èƒæ ¸éƒ½åƒé­šçœ¼ç›(??)ï¼›ç—¢ç–¾é˜¿ç±³å·´çš„ä¸­é–“æœ‰æ©Ÿæœƒçœ‹åˆ°å…©æ¢æ£’ç‹€æŸ“è‰²é«”ï¼Œä½†å¾®å°é˜¿ç±³å·´åªæœƒçœ‹åˆ°å››é¡†ç´°èƒæ ¸" },
            { id: 42, type: 'åŸèŸ²', img: "images/42.jpg", ans: ["Cyst of Entamoeba histolytica", "Cyst form of Entamoeba histolytica"], desc: "ç—¢ç–¾é˜¿ç±³å·´çš„å›Šé«” å…©é¡†ç´°èƒæ ¸)èˆ‡æ£’ç‹€æŸ“è‰²é«”" },
            { id: 43, type: 'åŸèŸ²', img: "images/43.jpg", ans: ["Trophozoite of Entamoeba histolytica", "Trophozoite form of Entamoeba histolytica"], desc: "ç—¢ç–¾é˜¿ç±³å·´çš„æ´»å‹•é«”" },
            { id: 44, type: 'åŸèŸ²', img: "images/44.jpg", ans: ["Cyst of Iodamoeba butschlii", "Cyst form of Iodamoeba butschlii"], desc: "å—œç¢˜é˜¿ç±³å·´çš„å›Šé«” å¯ä»¥çœ‹è¦‹å¾ˆåƒæ¶²æ³¡çš„è‚é†£æ³¡ï¼Œå¤§ç´„ä½”äº†æ•´å€‹ç´°èƒé¢ç©çš„1/3~1/2" },
            { id: 45, type: 'åŸèŸ²', img: "images/45.jpg", ans: ["Cyst of Balantidium coli", "Cyst form of Balantidium coli"], desc: "å¤§è…¸çº–æ¯›èŸ²çš„å›Šé«” å½¢ç‹€æ¥è¿‘åœ“çƒç‹€" },
            { id: 46, type: 'åŸèŸ²', img: "images/46.jpg", ans: ["Trophozoite of Balantidium coli", "Trophozoite form of Balantidium coli"], desc: "å¤§è…¸çº–æ¯›èŸ²çš„æ´»å‹•é«” å½¢ç‹€å‘ˆæ©¢åœ“ç‹€ " },
            { id: 47, type: 'åŸèŸ²', img: "images/47.jpg", ans: ["Cyst of Giardia lamblia", "Cyst form of Giardia lamblia"], desc: "æ¢¨å½¢é­æ¯›èŸ²çš„å›Šé«” ä¸­é–“æœ‰ä¸€ä¸­æŸ±æŠŠå››é¡†æ ¸å…©å…©éš”é–‹" },
            { id: 48, type: 'åŸèŸ²', img: "images/48.jpg", ans: ["Trophozoite of Giardia lamblia", "Trophozoite form of Giardia lamblia"], desc: "æ¢¨å½¢é­æ¯›èŸ²çš„æ´»å‹•é«” ä¸€ç«¯éˆä¸€ç«¯ç´°å°–ã€æ˜é¡¯å…©å€‹æ ¸" },
            { id: 49, type: 'åŸèŸ²', img: "images/49.jpg", ans: ["Trophozoite of Trichomonas vaginalis", "Trophozoite form of Trichomonas vaginalis"], desc: "é™°é“æ»´èŸ²çš„æ´»å‹•é«” å¤–å‹æ°´æ»´ç‹€ã€å–®æ ¸" },
            { id: 50, type: 'åŸèŸ²', img: "images/50.jpg", ans: ["Amastigote of Leishmania spp.", "Amastigote form of Leishmania spp."], desc: "åˆ©ä»€æ›¼èŸ²çš„ç„¡é­æ¯›é«” " },
            { id: 51, type: 'åŸèŸ²', img: "images/51.jpg", ans: ["Promastigote of Leishmania spp.", "Promastigote form of Leishmania spp."], desc: "åˆ©ä»€æ›¼èŸ²çš„å‰é­æ¯›é«”" },
            { id: 52, type: 'åŸèŸ²', img: "images/52.jpg", ans: ["Trypomastigote of Trypanosoma spp.", "Trypomastigote form of Trypanosoma spp."], desc: "éŒèŸ²çš„éŒé­æ¯›é«” èƒŒæ™¯ä¸­çš„åœ“åœˆæ˜¯ç´…è¡€çƒã€" },
            { id: 53, type: 'åŸèŸ²', img: "images/53.jpg", ans: ["Early trophozoite of Plasmodium vivax", "Early trophozoite form of Plasmodium vivax"], desc: "é–“æ—¥ç˜§åŸèŸ²æ—©æœŸæ´»å‹•é«” è·Ÿå…¶ä»–ç˜§åŸèŸ²æ¯”èµ·ä¾†,é–“æ—¥ç˜§åŸèŸ²çš„ç’°è¼ƒå¤§åœˆ" },
            { id: 54, type: 'åŸèŸ²', img: "images/54.jpg", ans: ["Mature trophozoite of Plasmodium vivax", "Mature trophozoite form of Plasmodium vivax"], desc: "é–“æ—¥ç˜§åŸèŸ²æˆç†Ÿçš„æ´»å‹•é«” æ˜é¡¯çš„è–›æ°é»(Schuffnerâ€™s dots)," },
            { id: 55, type: 'åŸèŸ²', img: "images/55.jpg", ans: ["Early trophozoite of Plasmodium falciparum", "Early trophozoite form of Plasmodium falciparum"], desc: "æƒ¡æ€§ç˜§åŸèŸ²æ—©æœŸæ´»å‹•é«” è€ƒè·‘å°æ™‚è‹¥æ˜¯çœ‹åˆ°ä¸€å€‹ç´…è¡€çƒä¸­æœ‰å…©éš»èŸ²ï¼Œå°±å¯«æƒ¡æ€§ç˜§åŸèŸ²ã€æˆ’æŒ‡ç’°ä¹Ÿæ¯”è¼ƒå°ä¸€é»" },
            { id: 56, type: 'åŸèŸ²', img: "images/56.jpg", ans: ["Trophozoite of Toxoplasma gondii", "Trophozoite form of Toxoplasma gondii"], desc: "å¼“èŸ²æ´»å‹•é«”" },
            { id: 57, type: 'çµ›èŸ²', img: "images/57.jpg", ans: ["Egg of Diphyllobothrium latum"], desc: "å»£ç¯€è£‚é ­çµ›èŸ²çš„èŸ²åµ å¤–è§€å‘ˆæ©¢åœ“ã€åµåœ“å½¢ï¼Œæœ‰è¨±å¤šåµç´°èƒã€é ­ç«¯æœ‰è£‚ç¸«=åµè“‹ (å¾®èª¿ç„¦è·)" },
            { id: 58, type: 'çµ›èŸ²', img: "images/58.jpg", ans: ["Gravid proglottid of Diphyllobothrium latum"], desc: "å»£ç¯€è£‚é ­çµ›èŸ²çš„å—å­•é«”ç¯€" },
            { id: 59, type: 'çµ›èŸ²', img: "images/59.jpg", ans: ["Egg of Taenia spp."], desc: "æœ‰é‰¤çµ›èŸ²åµ åƒç”œç”œåœˆã€è¼ªèƒ " },
            { id: 60, type: 'çµ›èŸ²', img: "images/60.jpg", ans: ["Gravid proglottid of Taenia solium"], desc: "å—å­•é«”ç¯€+æœ‰é‰¤çµ›èŸ² Taenia solium åˆ†æ”¯æ•¸è¼ƒå°‘ï¼›Taenia saginata åˆ†æ”¯æ•¸è¼ƒå¤š" },
            { id: 61, type: 'çµ›èŸ²', img: "images/61.jpg", ans: ["Gravid proglottid of Taenia saginata"], desc: "å—å­•é«”ç¯€+ç„¡é‰¤çµ›èŸ² Taenia solium åˆ†æ”¯æ•¸è¼ƒå°‘ï¼›Taenia saginata åˆ†æ”¯æ•¸è¼ƒå¤š" },
            { id: 62, type: 'çµ›èŸ²', img: "images/62.jpg", ans: ["Scolex of Taenia solium"], desc: "æœ‰é‰¤çµ›èŸ²çš„é ­ç¯€ åœ“å½¢å¸ç›¤(4å€‹) " },
            { id: 63, type: 'çµ›èŸ²', img: "images/63.jpg", ans: ["Egg of Hymenolepis diminuta"], desc: "ç¸®å°åŒ…è†œçµ›èŸ² æ­£åœ“å½¢" },
            { id: 64, type: 'çµ›èŸ²', img: "images/64.jpg", ans: ["Egg of Hymenolepis nana"], desc: "çŸ­å°åŒ…è†œçµ›èŸ² æ©¢åœ“å½¢ " },
            { id: 65, type: 'çµ›èŸ²', img: "images/65.jpg", ans: ["Egg capsule of Dipylidium caninum"], desc: "çŠ¬è¤‡æ®–å™¨çµ›èŸ²çš„åµ capsuleç›¸å°æ¯”è¼ƒå¤§ã€é•·å¾—åƒè‘¡è„" },
            { id: 66, type: 'çµ›èŸ²', img: "images/66.jpg", ans: ["Proglottid of Dipylidium caninum"], desc: "çŠ¬è¤‡æ®–å™¨çµ›èŸ²çš„é«”ç¯€ " },
            { id: 67, type: 'çµ›èŸ²', img: "images/67.jpg", ans: ["Hydatid cyst of Echinococcus granulosus"], desc: "å–®èƒçµ›èŸ²çš„æ°´å›Š" },
            { id: 68, type: 'çµ›èŸ²', img: "images/68.jpg", ans: ["Protoscolex of Echinococcus granulosus"], desc: "å–®èƒçµ›èŸ²çš„åŸå§‹é ­ç¯€ " }
        ];
        // ==========================================

        let questions = [];
        let userRecords = [];
        let currentIdx = 0;
        let score = 0;
        let nickname = "";
        let currentMode = "ranked"; 
        let timerInterval;
        let timeLeft = timePerQuestion;

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- æ ¸å¿ƒéŠæˆ²é‚è¼¯ä¿®æ­£ï¼šå…ˆæª¢æŸ¥è¼¸å…¥ï¼Œè¨ˆæ™‚æ¨¡å¼æ‰è·³çª— ---
        function checkStart(mode) {
            const nickInput = document.getElementById('nickname');
            nickname = nickInput.value.trim();
            currentMode = mode;

            // 1. æª¢æŸ¥æš±ç¨± (åªæœ‰æ’åæ¨¡å¼å¼·åˆ¶)
            if (mode === 'ranked') {
                if (!nickname) { alert("è«‹å…ˆè¼¸å…¥æš±ç¨±"); return; }
                // é¡¯ç¤ºç§’æ•¸é¸æ“‡å½ˆçª—
                document.getElementById('timer-modal').style.display = 'flex';
            } else {
                if (!nickname) nickname = "";
                initializeGame(mode); // å…¶ä»–æ¨¡å¼ç›´æ¥é–‹å§‹
            }
        }

        // 2. æ’åæ¨¡å¼ä¸‹ï¼Œç¢ºèªç§’æ•¸å¾Œæ‰é–‹å§‹
        function confirmRanked(seconds) {
            timePerQuestion = seconds;
            document.getElementById('timer-modal').style.display = 'none';
            initializeGame('ranked');
        }

        function closeTimerModal() {
            document.getElementById('timer-modal').style.display = 'none';
        }

        // 3. å¯¦éš›åˆå§‹åŒ–éŠæˆ² (å…±ç”¨)
        function initializeGame(mode) {
            const selectedType = document.getElementById('category-select').value;
            let pool = [];
            if (selectedType === 'all') {
                pool = [...database];
            } else {
                pool = database.filter(item => item.type === selectedType);
            }

            if (pool.length === 0) {
                alert(`ç›®å‰é‚„æ²’æœ‰ "${selectedType}" çš„é¡Œç›®å–”ï¼`);
                return;
            }

            let inputLimit = parseInt(document.getElementById('question-limit').value);
            if (isNaN(inputLimit) || inputLimit < 1) inputLimit = 10;
            const finalLimit = Math.min(inputLimit, pool.length);

            document.getElementById('login-section').classList.remove('active');
            document.getElementById('game-section').classList.add('active');
            
            let modeTitle = "";
            if (mode === 'ranked') modeTitle = "ğŸ† æ’åæŒ‘æˆ°";
            else if (mode === 'practice') modeTitle = "ğŸ“ æ¨¡æ“¬æ¸¬é©—";
            else modeTitle = "ğŸƒ ç¿»å¡è¨˜æ†¶";

            document.getElementById('player-display').innerText = `${modeTitle} - ${nickname} (${selectedType}) - å…± ${finalLimit} é¡Œ`;

            // æ§åˆ¶æŒ‰éˆ•å’Œè¨ˆæ™‚å™¨é¡¯ç¤º
            const submitBtn = document.getElementById('submit-early-btn');
            
            if (mode === 'ranked') {
                document.getElementById('timer-area').style.display = 'flex';
                submitBtn.style.display = 'block';
            } else if (mode === 'practice') {
                document.getElementById('timer-area').style.display = 'none';
                submitBtn.style.display = 'block';
            } else { // flashcard
                document.getElementById('timer-area').style.display = 'none';
                submitBtn.style.display = 'block'; 
                submitBtn.innerText = "ğŸ çµæŸé–±è¦½";
            }

            questions = shuffle(pool).slice(0, finalLimit); 
            userRecords = [];
            currentIdx = 0;
            score = 0;
            loadCard();
        }

        function startTimer() {
            clearInterval(timerInterval);
            timeLeft = timePerQuestion; // é‡ç½®ç‚ºé¸æ“‡çš„ç§’æ•¸
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    handleTimeOut();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            document.getElementById('timer-text').innerText = timeLeft;
            const bar = document.getElementById('timer-bar');
            // è¨ˆç®—æ¯”ä¾‹ä½¿ç”¨ç›®å‰çš„ timePerQuestion
            const percent = (timeLeft / timePerQuestion) * 100;
            bar.style.width = `${percent}%`;
            if (timeLeft <= 10) bar.classList.add('timer-warning');
            else bar.classList.remove('timer-warning');
        }

        function handleTimeOut() {
            checkAnswer(null, true); 
        }

        function loadCard() {
            if (currentIdx >= questions.length) {
                endGame();
                return;
            }

            const q = questions[currentIdx];
            const imgEl = document.getElementById('q-image');
            imgEl.src = q.img;
            
            // æ›´æ–°é€²åº¦æ¢
            document.getElementById('progress-text').innerText = `é€²åº¦ï¼š${currentIdx + 1} / ${questions.length}`;
            
            // æª¢æŸ¥é€™ä¸€é¡Œæ˜¯å¦å·²ç¶“å›ç­”é (User Records ä¸­æ˜¯å¦æœ‰ç´€éŒ„)
            const answeredRecord = userRecords[currentIdx]; // å› ç‚ºæ˜¯ä¾åºçš„ï¼Œç›´æ¥ç”¨ index å–
            const card = document.getElementById('flashcard');
            const inputEl = document.getElementById('user-input');
            const resultTitle = document.getElementById('result-title');
            const descEl = document.getElementById('ans-desc');
            const flashcardHint = document.getElementById('flashcard-hint');
            const quizHint = document.getElementById('quiz-hint');
            const inputArea = document.getElementById('input-area');
            
            // æŒ‰éˆ•ç‹€æ…‹æ§åˆ¶
            document.getElementById('prev-btn').disabled = (currentIdx === 0);
            
            // è¨­å®šç‰¹å¾µæè¿°
            const descText = q.desc ? `ç‰¹å¾µï¼š${q.desc}` : ""; // å¦‚æœæ²’æè¿°å°±ç•™ç©º
            descEl.innerText = descText;

            // === ç‹€æ…‹ 1: å·²å›ç­”éçš„é¡Œç›® (å›é ­æª¢æŸ¥) ===
            if (answeredRecord) {
                // é¡¯ç¤ºå·²å›ç­”çš„ç‹€æ…‹
                card.classList.add('is-flipped'); // ç¿»åˆ°èƒŒé¢
                inputEl.value = answeredRecord.userAnswer === "(æ™‚é–“åˆ°)" ? "" : answeredRecord.userAnswer;
                inputEl.disabled = true;

                if (answeredRecord.isCorrect) {
                    resultTitle.innerHTML = "âœ… ç­”å°äº†ï¼";
                    resultTitle.className = "result-text correct";
                } else {
                    resultTitle.innerHTML = answeredRecord.userAnswer === "(æ™‚é–“åˆ°)" ? "â° æ™‚é–“åˆ°" : "âŒ ç­”éŒ¯äº†ï¼";
                    resultTitle.className = "result-text wrong";
                }
                document.getElementById('correct-answer').innerText = answeredRecord.correctAnswers;
                
                // åœæ­¢è¨ˆæ™‚å™¨ (å¦‚æœæ˜¯åœ¨å›çœ‹)
                clearInterval(timerInterval);
                
                // â˜… ç¿»é¢å¾Œéš±è—æç¤º
                flashcardHint.style.display = 'none';
                quizHint.style.display = 'none';

            } else {
                // === ç‹€æ…‹ 2: æ–°é¡Œç›® ===
                card.classList.remove('is-flipped'); // è½‰å›æ­£é¢
                inputEl.value = "";
                inputEl.disabled = false;
                
                if (currentMode === 'flashcard') {
                    inputArea.style.display = "none";
                    quizHint.style.display = "none";
                    flashcardHint.style.display = "block"; // é¡¯ç¤ºé»æ“Šæç¤º
                    card.style.cursor = "pointer"; 
                    document.getElementById('result-title').style.display = "none"; 
                    document.getElementById('correct-answer').innerText = q.ans[0];
                    // ç¿»å¡æ¨¡å¼ç›´æ¥é¡¯ç¤ºæè¿°
                    descEl.innerText = descText; 
                } else {
                    inputArea.style.display = "block";
                    quizHint.style.display = "block"; // é¡¯ç¤ºè¼¸å…¥æç¤º
                    flashcardHint.style.display = "none";
                    card.style.cursor = "default"; 
                    document.getElementById('result-title').style.display = "block";
                    
                    setTimeout(() => inputEl.focus(), 300);
                    if (currentMode === 'ranked') startTimer();
                }
            }
            
            // æ›´æ–°ã€Œä¸‹ä¸€é¡Œã€æŒ‰éˆ•æ–‡å­—
            const nextBtnText = (currentIdx >= questions.length - 1) ? "äº¤å· ğŸ" : "ä¸‹ä¸€é¡Œ â¡ï¸";
            document.getElementById('card-next-btn').innerText = nextBtnText;
            document.getElementById('skip-btn').innerText = nextBtnText;
        }

        function prevQuestion() {
            if (currentIdx > 0) {
                currentIdx--;
                loadCard();
            }
        }

        function onCardClick() {
            if (currentMode !== 'flashcard') return; 
            const card = document.getElementById('flashcard');
            const hint = document.getElementById('flashcard-hint');
            
            // ç¿»è½‰å¡ç‰‡
            const isNowFlipped = card.classList.toggle('is-flipped');
            
            // â˜… å¦‚æœç¿»åˆ°èƒŒé¢(çœ‹ç­”æ¡ˆ)ï¼Œéš±è—æç¤ºæ–‡å­—ï¼›ç¿»å›æ­£é¢å‰‡é¡¯ç¤º
            if (isNowFlipped) {
                hint.style.display = 'none';
            } else {
                hint.style.display = 'block';
            }
        }

        function checkAnswer(event, isTimeOut = false) {
            if (event) event.stopPropagation(); 
            if (currentMode === 'ranked') clearInterval(timerInterval);

            const inputEl = document.getElementById('user-input');
            const userVal = inputEl.value.trim().toLowerCase();
            inputEl.disabled = true;

            let correctVals = questions[currentIdx].ans;
            if (!Array.isArray(correctVals)) correctVals = [correctVals];
            
            const isCorrect = correctVals.some(ans => ans.toLowerCase() === userVal);
            
            // å¯«å…¥ç´€éŒ„ (é¿å…é‡è¤‡å¯«å…¥ï¼šåªæœ‰ç•¶ç›®å‰ index ç­‰æ–¼ç´€éŒ„é•·åº¦æ™‚æ‰ push)
            if (userRecords.length === currentIdx) {
                userRecords.push({
                    question: questions[currentIdx],
                    userAnswer: isTimeOut ? "(æ™‚é–“åˆ°)" : userVal,
                    isCorrect: isCorrect && !isTimeOut,
                    correctAnswers: correctVals[0]
                });
            }

            const resultTitle = document.getElementById('result-title');
            if (isCorrect && !isTimeOut) {
                resultTitle.innerHTML = "âœ… ç­”å°äº†ï¼";
                resultTitle.className = "result-text correct";
                score++;
            } else {
                resultTitle.innerHTML = isTimeOut ? "â° æ™‚é–“åˆ°ï¼" : "âŒ ç­”éŒ¯äº†ï¼";
                resultTitle.className = "result-text wrong";
            }

            document.getElementById('correct-answer').innerText = correctVals[0];
            
            // å¡«å…¥æè¿°
            const q = questions[currentIdx];
            document.getElementById('ans-desc').innerText = q.desc ? `ç‰¹å¾µï¼š${q.desc}` : "";

            document.getElementById('flashcard').classList.add('is-flipped');
            
            // â˜… ç­”é¡Œç¿»é¢å¾Œéš±è—æç¤º
            document.getElementById('quiz-hint').style.display = 'none';
            
            // èšç„¦åœ¨èƒŒé¢çš„ä¸‹ä¸€é¡ŒæŒ‰éˆ•
            document.getElementById('card-next-btn').focus();
        }

        function nextQuestion(event) {
            if (event) event.stopPropagation(); 
            
            // å¦‚æœé‚„æ²’å›ç­”å°±æŒ‰ä¸‹ä¸€é¡Œ (è·³é)
            if (userRecords.length === currentIdx) {
                 // å¼·åˆ¶è¦–ç‚ºç­”éŒ¯/è·³é
                 // checkAnswer(null, true); // å¦‚æœå¸Œæœ›è·³éç®—ç­”éŒ¯ï¼Œå–æ¶ˆé€™è¡Œè¨»è§£
                 // é€™è£¡æˆ‘å€‘ç°¡å–®è™•ç†ï¼šè·³éä¸ç®—åˆ†ï¼Œä½†è¨˜éŒ„ä¸€ä¸‹
                 userRecords.push({
                    question: questions[currentIdx],
                    userAnswer: "(è·³é)",
                    isCorrect: false,
                    correctAnswers: questions[currentIdx].ans[0]
                });
                score += 0;
            }

            currentIdx++;
            if (currentIdx < questions.length) {
                // å¦‚æœæ˜¯æ–°é¡Œç›®ï¼Œè¦ç¿»å›æ­£é¢
                if(currentIdx === userRecords.length) {
                     document.getElementById('flashcard').classList.remove('is-flipped');
                }
                setTimeout(loadCard, 300); 
            } else {
                endGame();
            }
        }

        function endGame() {
            clearInterval(timerInterval);
            document.getElementById('game-section').classList.remove('active');
            document.getElementById('summary-section').classList.add('active');
            
            document.getElementById('score-tabs').style.display = "flex";
            const leaderboardBtn = document.getElementById('btn-leaderboard');
            leaderboardBtn.style.display = "inline-block"; 

            if (currentMode === 'flashcard') {
                document.getElementById('final-score').innerText = "ğŸ‰ è¤‡ç¿’å®Œæˆï¼";
                document.getElementById('score-tabs').style.display = "none"; 
                document.getElementById('personal-list').innerHTML = "<p style='text-align:center'>å·²å®Œæˆæ‰€æœ‰åœ–å¡é–±è¦½ã€‚</p>";
                document.getElementById('upload-status').innerText = "";
            } else {
                document.getElementById('final-score').innerText = `${nickname} çš„å¾—åˆ†ï¼š${score} / ${questions.length}`;
                renderPersonalList();
                
                if (currentMode === 'ranked') {
                    uploadScoreAndGetLeaderboard();
                } else {
                    document.getElementById('upload-status').innerText = "ğŸ“ ç·´ç¿’æ¨¡å¼ä¸ç´€éŒ„åˆ†æ•¸";
                    leaderboardBtn.style.display = "none"; 
                    switchTab('personal');
                }
            }
        }

        function renderPersonalList() {
            const listDiv = document.getElementById('personal-list');
            listDiv.innerHTML = "";
            
            if (userRecords.length === 0) {
                listDiv.innerHTML = "<p style='text-align:center; padding:20px;'>æ²’æœ‰ç­”é¡Œç´€éŒ„</p>";
                return;
            }

            userRecords.forEach((record, index) => {
                const item = document.createElement('div');
                item.className = record.isCorrect ? "summary-item" : "summary-item item-wrong";
                // å€‹äººæˆç¸¾å–®ä¹ŸåŠ ä¸Šç‰¹å¾µæè¿°
                const descText = record.question.desc ? `<br><span style="font-size:0.9em; color:#856404; background:#fff3cd; padding:2px 5px; border-radius:3px;">${record.question.desc}</span>` : "";

                item.innerHTML = `
                    <img src="${record.question.img}" class="summary-thumb" onclick="window.open(this.src)">
                    <div class="summary-info">
                        <strong>ç¬¬ ${index + 1} é¡Œï¼š${record.correctAnswers}</strong>
                        ${descText}
                        <br>
                        <span style="color:#666">ä½ çš„å›ç­”ï¼š${record.userAnswer || "(ç©ºç™½)"}</span>
                    </div>
                    <div class="status-badge ${record.isCorrect ? 'ok' : 'no'}">${record.isCorrect ? 'æ­£ç¢º' : 'éŒ¯èª¤'}</div>
                `;
                listDiv.appendChild(item);
            });
        }

        function uploadScoreAndGetLeaderboard() {
            const statusEl = document.getElementById('upload-status');
            statusEl.innerText = "æ­£åœ¨ä¸Šå‚³æˆç¸¾...";
            if (GOOGLE_SCRIPT_URL.includes("ä½ çš„ID")) { statusEl.innerText = "âš ï¸ æœªè¨­å®šç¶²å€"; return; }

            fetch(GOOGLE_SCRIPT_URL, {
                method: "POST", mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name: nickname, score: score })
            }).then(() => {
                statusEl.innerText = "åˆ†æ•¸ä¸Šå‚³æˆåŠŸï¼æ›´æ–°æ’è¡Œæ¦œä¸­...";
                return fetch(GOOGLE_SCRIPT_URL);
            }).then(response => response.json())
            .then(data => {
                renderLeaderboard(data);
                statusEl.innerText = "âœ… æˆç¸¾å·²ä¸Šå‚³ï¼Œæ’è¡Œæ¦œå·²æ›´æ–°";
            }).catch(error => { console.error(error); statusEl.innerText = "é€£ç·šå¤±æ•—"; });
        }

        function fetchLeaderboardOnly() { /* ç·´ç¿’æ¨¡å¼ä¸éœ€æ­¤åŠŸèƒ½ */ }

        function renderLeaderboard(data) {
            const tbody = document.getElementById('rank-body');
            tbody.innerHTML = "";
            
            const top5 = data.slice(0, 5); 

            top5.forEach((row, index) => {
                let rankClass = "";
                if(index === 0) rankClass = "rank-1";
                if(index === 1) rankClass = "rank-2";
                if(index === 2) rankClass = "rank-3";
                
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="${rankClass}">#${index + 1}</td><td style="font-weight:bold">${row.name}</td><td>${row.score}</td>`;
                tbody.appendChild(tr);
            });
        }

        function switchTab(tabName) {
            document.querySelectorAll('.list-container').forEach(el => el.classList.remove('show'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active-tab'));
            if(tabName === 'personal') {
                document.getElementById('personal-list').classList.add('show');
                document.querySelector('button[onclick="switchTab(\'personal\')"]').classList.add('active-tab');
            } else {
                document.getElementById('leaderboard-list').classList.add('show');
                document.getElementById('btn-leaderboard').classList.add('active-tab');
            }
        }

        // --- åœ–é‘‘åŠŸèƒ½ (æ”¹ç‚ºæ¢åˆ—å¼è¡¨æ ¼) ---
        function openGallery() {
            document.getElementById('login-section').classList.remove('active');
            document.getElementById('gallery-section').classList.add('active');
            filterGallery();
        }

        function filterGallery() {
            const type = document.getElementById('gallery-filter-select').value;
            const container = document.getElementById('gallery-container');
            container.innerHTML = "";

            let items = (type === 'all') ? database : database.filter(d => d.type === type);

            if(items.length === 0) {
                container.innerHTML = "<p style='text-align:center'>ç„¡è³‡æ–™</p>";
                return;
            }

            // å»ºç«‹è¡¨æ ¼ HTML
            let html = '<table class="gallery-table"><thead><tr><th style="width:50px">ID</th><th style="width:80px">åœ–ç‰‡</th><th>åç¨±</th><th>ç‰¹å¾µ/æè¿°</th></tr></thead><tbody>';
            
            items.forEach(item => {
                const descDisplay = item.desc ? item.desc : "<span style='color:#ccc; font-style:italic;'>æš«ç„¡æè¿°</span>";
                
                // æ³¨æ„ï¼šé€™è£¡ onclick å‚³éåƒæ•¸æ¯”è¼ƒè¤‡é›œï¼Œæˆ‘å€‘æ”¹ç”¨ function ç¶å®š
                // ä½†ç‚ºäº†ç°¡å–®ï¼Œç›´æ¥çµ„å­—ä¸²
                html += `<tr>
                    <td>${item.id}</td>
                    <td><img src="${item.img}" class="gallery-thumb-small" onclick="showOverlay('${item.img}', '${item.ans[0].replace(/'/g, "\\'")}', '${item.desc ? item.desc.replace(/'/g, "\\'") : ""}')"></td>
                    <td>${item.ans[0]}</td>
                    <td>${descDisplay}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function showOverlay(imgSrc, title, desc) {
            const overlay = document.getElementById('gallery-overlay');
            document.getElementById('overlay-img').src = imgSrc;
            document.getElementById('overlay-text').innerText = title;
            document.getElementById('overlay-desc').innerText = desc ? `ç‰¹å¾µï¼š${desc}` : "";
            overlay.style.display = 'flex';
        }

        function closeGalleryOverlay() {
            document.getElementById('gallery-overlay').style.display = 'none';
        }

        document.getElementById('user-input').addEventListener('keypress', (e) => { 
            if(e.key === 'Enter') checkAnswer(e); 
        });
        document.getElementById('nickname').addEventListener('keypress', (e) => { 
            if(e.key === 'Enter') checkStart('ranked'); // æ”¹æˆ checkStart
        });

    </script>
</body>
</html>








